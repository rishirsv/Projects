# Installation & Setup Guide

> Step-by-step instructions to deploy the Personal Capital Apps Script, configure Google Sheets, and prepare Python utilities.

## Table of Contents
- [System Requirements](#system-requirements)
- [Google Apps Script Deployment](#google-apps-script-deployment)
- [Spreadsheet Preparation](#spreadsheet-preparation)
- [Python Environment](#python-environment)
- [Configuration Files](#configuration-files)
- [Verification Checklist](#verification-checklist)
- [Troubleshooting](#troubleshooting)

## System Requirements
| Component | Requirement | Notes |
| --- | --- | --- |
| Google Account | Workspace or personal | Access to Google Drive & Apps Script |
| CLASP | `@google/clasp` v2.4+ | `npm install -g @google/clasp` |
| Node.js | 18+ | Required for CLASP authentication |
| Python | 3.10+ | For digest scripts (`process_net_worth.py`, `process_ibkr_digests.py`) |
| Browser | Chrome/Edge/Firefox | Needed to capture bank CSVs and run dialogs |

## Google Apps Script Deployment
1. Clone the repository and change to the project directory:
   ```bash
   git clone <repo>
   cd "Personal Capital"
   ```
2. Install CLASP globally if you have not already:
   ```bash
   npm install -g @google/clasp
   ```
3. Authenticate with your Google account:
   ```bash
   clasp login
   ```
4. Pull the project manifest if needed (`clasp pull`) or push the current code to Apps Script:
   ```bash
   clasp push
   ```
5. Open the Apps Script editor (`clasp open`) to review triggers and enable required services (none by default).

> ⚠️ Ensure you deploy from the correct Google account. Shared drives may require additional permissions.

## Spreadsheet Preparation
1. Create a Google Sheet (or open an existing finance workbook).
2. Add the following sheets with matching headers:

| Sheet Name | Purpose | Required Headers |
| --- | --- | --- |
| `STG_Transactions` | Staging area for imported CSV rows | Date, Vendor, Amount, Category, Source, RuleID, Confidence |
| `Transactions` | Final ledger | Date, Vendor, Amount, Category, Source |
| `SYS_ImportLog` | Import audit log | Timestamp, Bank, Rows Read, Rows Kept, Rows Skipped |
| `SYS_CatRules` | Categorization rules | Pattern, Category, Priority, MinAmt, MaxAmt, Type, Notes |

3. Run the `Personal Capital` → `Import CSV(s)…` menu once; the script automatically calls `ensureSheets()` to create missing sheets and bold the headers.
4. Populate `SYS_CatRules` with initial rules (see [Configuration](./configuration.md)).

## Python Environment
1. Create and activate a virtual environment:
   ```bash
   python3 -m venv .venv
   source .venv/bin/activate
   ```
2. Install dependencies:
   ```bash
   pip install -r requirements.txt  # create if needed
   ```
   > ✅ The repository uses ad-hoc scripts; export requirements via `pip freeze > requirements.txt` once packages are confirmed.
3. Run digest scripts from the project root:
   ```bash
   python3 process_net_worth.py
   python3 process_ibkr_digests.py --help
   ```
4. Place raw CSV exports in the `docs/` directory (`Net Worth.csv`, `PF_IBKR_*.csv`) as expected by each script.

## Configuration Files
- `.clasp.json`: Generated by CLASP; stores script ID and push/pull behavior.
- `Code.js`: Core Apps Script. Update cautiously; always run unit smoke tests (manual) before deploying to production sheets.
- Python scripts read files from `docs/` and emit digest CSVs in the project root.

> ⚠️ Do not hardcode credentials in the codebase. Use Apps Script Properties (`PropertiesService`) or Google Secrets Manager if future features require external APIs.

## Verification Checklist
- `clasp push` completes without errors.
- `Personal Capital` custom menu appears after reloading the Google Sheet.
- Import dialog opens and allows file uploads.
- Sample AMEX CSV loads into `STG_Transactions` with correct headers.
- `Import Staging → Transactions` moves rows into the ledger within the selected date range.
- Python scripts generate digest CSVs with recent timestamps.

## Troubleshooting
| Issue | Cause | Resolution |
| --- | --- | --- |
| `Exception: Service invoked too many times` | Apps Script quotas exceeded | Batch imports, add delays, or split files |
| `ReferenceError: importCsvFiles is not defined` | CLASP push incomplete | Ensure all `.html` and `.js` files exist and re-run `clasp push` |
| Dialog fails to open | HTML file missing or renamed | Confirm filenames in `HtmlService.createHtmlOutputFromFile()` |
| Python script cannot find CSV | Wrong path | Place input files under `docs/` or pass explicit `--input` flag (see script help) |
